pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/SanZer3/angular_app.git'
            }
        }

        stage('Test') {
            steps {
                script {
                    // Exécuter les tests unitaires et les tests d'intégration
                    sh 'npm install'
                    sh 'npm run test'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                // Construire l'image Docker
                sh 'docker build -t sanzer3/angular-app:latest .'
            }
        }

        stage('Deploy Blue or Green Environment') {
            steps {
                // Variables pour les noms des conteneurs
                def blueContainer = 'angular-blue'
                def greenContainer = 'angular-green'
                
                // Basculer entre les environnements bleu et vert
                // Vérifier quel environnement est actuellement déployé
                script {
                    if (docker.inspect(name: blueContainer, returnStatus: true).status == 0) {
                        // Si l'environnement bleu est actif, déployer sur l'environnement vert
                        echo 'Déploiement sur l\'environnement vert'
                        sh "docker stop $blueContainer || true"
                        sh "docker run -d --name $greenContainer -p 8081:80 sanzer3/angular-app:latest"
                    } else {
                        // Sinon, déployer sur l'environnement bleu
                        echo 'Déploiement sur l\'environnement bleu'
                        sh "docker stop $greenContainer || true"
                        sh "docker run -d --name $blueContainer -p 8080:80 sanzer3/angular-app:latest"
                    }
                }
            }
        }

        stage('Finalize Deployment') {
            steps {
                // Effectuez des tests supplémentaires si nécessaire
                // Nettoyez les ressources inutilisées
                sh 'docker stop angular-blue'
                sh 'docker stop angular-green'
            }
        }
    }

    post {
        success {
            echo 'Déploiement réussi !'
        }
        failure {
            echo 'Échec du déploiement !'
        }
    }
}
